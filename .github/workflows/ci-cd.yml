name: ğŸš€ TechFood API - Deploy Only

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - "**"

env:
  NAMESPACE: techfood
  AWS_REGION: us-east-1

jobs:
  deploy-to-eks:
    name: ğŸš€ Deploy API to EKS
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
    - name: âš™ï¸ Configure AWS credentials (AWS Academy)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: ${{ env.AWS_REGION }}
        mask-aws-account-id: false

    - name: ğŸ” Verify AWS credentials
      run: |
        echo "ğŸ” Verifying AWS credentials..."
        aws sts get-caller-identity
        echo "ğŸ“‹ Checking EKS cluster access..."
        aws eks describe-cluster --region ${{ env.AWS_REGION }} --name eks-techfood-terraform --query 'cluster.{Name:name,Status:status,Endpoint:endpoint}' --output table

    - name: ğŸ“‹ Update kubeconfig for EKS
      run: |
        echo "ğŸ“‹ Updating kubeconfig for EKS cluster..."
        aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name eks-techfood-terraform
        echo "âœ… Kubeconfig updated successfully"
        kubectl config current-context
        kubectl cluster-info --request-timeout=30s

    - name: ğŸš€ Deploy API to EKS
      run: |
        echo "ğŸš€ Deploying techfood-api to EKS..."
        echo "ğŸ“¦ Using image: ${{ secrets.DOCKERHUB_USERNAME }}/techfood-api:latest"
        kubectl set image deployment/techfood-api techfood-api=${{ secrets.DOCKERHUB_USERNAME }}/techfood-api:latest -n ${{ env.NAMESPACE }}
        kubectl rollout status deployment/techfood-api -n ${{ env.NAMESPACE }} --timeout=300s

    - name: âœ… Deployment Summary
      run: |
        echo "ğŸ‰ TechFood API deployed successfully!"
        echo "ğŸ·ï¸ Image: ${{ secrets.DOCKERHUB_USERNAME }}/techfood-api:latest"
        echo "ğŸ“… Deployed at: $(date)"
        kubectl get pods -l app.kubernetes.io/name=techfood-api -n ${{ env.NAMESPACE }}
